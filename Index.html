<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>NeonStream - Accueil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #05030a;
      --bg-alt: #0b0715;
      --accent: #a855f7;
      --accent-strong: #e879f9;
      --accent-soft: rgba(168, 85, 247, 0.35);
      --text: #f9f5ff;
      --text-muted: #a1a1aa;
      --border: rgba(148, 163, 184, 0.25);
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .hidden { display: none !important; }

    /* --- HEADER --- */
    header {
      position: fixed; top: 0; left: 0; width: 100%; height: 80px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px; 
      z-index: 1000; /* Z-INDEX TR√àS HAUT POUR PASSER AU DESSUS DU FILM */
      
      background: rgba(5, 3, 10, 0.15); 
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
      
      transform: translateY(0);
      transition: transform 0.5s cubic-bezier(0.33, 1, 0.68, 1), background 0.3s ease;
    }
    
    header.scrolled { background: rgba(5, 3, 10, 0.95); }

    /* CLASSE QUI CACHE LE HEADER VERS LE HAUT */
    header.header-auto-hide {
      transform: translateY(-100%);
    }

    .header-left, .header-right { display: flex; align-items: center; gap: 15px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-pill {
      width: 38px; height: 38px; border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #f97316, transparent 50%),
                  radial-gradient(circle at 70% 80%, #a855f7, transparent 55%);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
    }
    .logo-title { font-weight: 700; font-size: 1rem; letter-spacing: 0.05em; text-transform: uppercase; }
    .logo-sub { font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.1em; }

    .btn-dev, .btn-dev-primary {
      border-radius: 999px; padding: 8px 16px; font-size: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.15); background: rgba(255, 255, 255, 0.05);
      color: #fff; cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em;
      transition: all 0.2s ease; white-space: nowrap;
    }
    .btn-dev:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--accent); }
    .btn-dev-primary { background: var(--accent); border-color: transparent; box-shadow: 0 0 15px rgba(168, 85, 247, 0.5); }
    .btn-dev-primary:hover { box-shadow: 0 0 25px rgba(168, 85, 247, 0.8); transform: translateY(-1px); }

    /* SEARCH */
    .search-wrapper { position: relative; width: 280px; }
    .search-input {
      width: 100%; padding: 8px 34px 8px 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1); background: rgba(0, 0, 0, 0.3);
      color: #fff; font-size: 0.85rem; outline: none; transition: all 0.2s;
    }
    .search-input:focus { border-color: var(--accent); background: rgba(0, 0, 0, 0.6); box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
    .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }

    .search-dropdown {
      position: absolute; top: 120%; right: 0; width: 320px;
      background: rgba(15, 15, 25, 0.95); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; backdrop-filter: blur(20px); box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      overflow-y: auto; max-height: 400px; display: none; z-index: 200;
    }
    .search-dropdown.active { display: block; }
    .search-result-item { display: flex; gap: 12px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
    .search-result-item:hover { background: rgba(168, 85, 247, 0.15); }
    .search-result-thumb { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; background: #222; }
    .search-result-info { display: flex; flex-direction: column; justify-content: center; }
    .search-result-title { font-size: 0.9rem; font-weight: 600; color: #fff; }
    .search-result-meta { font-size: 0.75rem; color: var(--text-muted); }
    .search-no-result { padding: 15px; text-align: center; font-size: 0.85rem; color: var(--text-muted); }

    /* --- HERO --- */
    .hero-container {
      position: relative; 
      width: 100%; 
      height: 85vh; 
      display: flex; align-items: flex-end; overflow: hidden; margin-bottom: 20px;
      background: #000;
      transition: height 0.8s ease;
    }
    
    /* MODE CINEMA : PLEINE HAUTEUR */
    .hero-container.playing-mode {
      height: 100vh;
      margin-bottom: 0;
    }

    .hero-bg-video { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      z-index: 0; 
    }
    
    .hero-bg-video video { 
      width: 100%; height: 100%; 
      object-fit: cover; 
      transition: object-fit 0.5s ease;
    }
    
    .hero-overlay-gradient {
      position: absolute; inset: 0; z-index: 1; pointer-events: none;
      background: linear-gradient(
        to bottom,
        var(--bg) 0%, 
        transparent 15%, 
        transparent 80%, 
        var(--bg) 100%
      );
      transition: opacity 0.5s ease;
    }
    
    /* En mode lecture, on cache le d√©grad√© et le texte, mais PAS le header (g√©r√© par JS) */
    .hero-container.playing-mode .hero-overlay-gradient,
    .hero-container.playing-mode .hero-content {
      opacity: 0 !important;
      pointer-events: none;
    }

    .hero-content {
      position: relative; z-index: 2; margin: 0 0 60px 60px; width: 100%; max-width: 600px;
      background: rgba(15, 20, 35, 0.35); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5); opacity: 0; transform: translateY(20px);
      animation: heroContentFadeIn 0.8s ease forwards 0.5s;
      transition: opacity 0.5s ease;
    }
    @keyframes heroContentFadeIn { to { opacity: 1; transform: translateY(0); } }
    
    .hero-chip {
      display: inline-flex; align-items: center; gap: 8px; padding: 5px 12px;
      border-radius: 99px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; background: rgba(255,255,255,0.1); color: #cbd5e1; margin-bottom: 16px;
    }
    .hero-title {
      font-size: 3rem; font-weight: 700; line-height: 1.1; margin-bottom: 12px;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
      background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .hero-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.85rem; color: #cbd5e1; margin-bottom: 20px; }
    .badge { padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
    .hero-desc {
      font-size: 1rem; line-height: 1.6; color: #e2e8f0; margin-bottom: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
    }
    .hero-actions { display: flex; gap: 12px; }
    
    .btn-hero-play {
      background: #fff; color: #000; border: none; padding: 12px 28px; border-radius: 99px;
      font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;
    }
    .btn-hero-play:hover { transform: scale(1.05); }
    .btn-hero-info {
      background: rgba(109, 109, 110, 0.7); color: #fff; border: none; padding: 12px 28px;
      border-radius: 99px; font-weight: 600; font-size: 1rem; cursor: pointer;
      backdrop-filter: blur(4px); transition: background 0.2s, transform 0.2s;
    }
    .btn-hero-info:hover { background: rgba(109, 109, 110, 0.9); transform: scale(1.05); }
    .btn-hero-mute {
      width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2); color: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.2s;
    }
    .btn-hero-mute:hover { background: rgba(255,255,255,0.3); }

    /* --- CONTENU --- */
    .main-content {
      max-width: 100%;
      margin: 0;
      padding: 0 0 60px 0;
      position: relative; z-index: 10;
    }

    .section-header {
      padding: 0 40px; margin-bottom: 12px;
      display: flex; align-items: baseline; gap: 12px;
    }
    .section-title { font-size: 1.3rem; font-weight: 600; color: #fff; }

    /* CARROUSEL */
    .row-wrapper { position: relative; width: 100%; }

    .movie-row {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 16px;
      padding: 10px 40px 30px 40px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; -ms-overflow-style: none;
    }
    .movie-row::-webkit-scrollbar { display: none; }

    .movie-card {
      flex: 0 0 auto; width: 200px; cursor: pointer;
      transition: transform 0.3s, opacity 0.3s;
    }
    .movie-card.dimmed { opacity: 0.2; filter: grayscale(1); pointer-events: none; }

    .poster-wrapper {
      aspect-ratio: 2/3; border-radius: 12px; overflow: hidden; position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .poster-wrapper img { width: 100%; height: 100%; object-fit: cover; }

    .movie-card:hover:not(.dimmed) .poster-wrapper {
      transform: scale(1.08); z-index: 20;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      border: 2px solid rgba(255,255,255,0.2);
    }
    .movie-title-mini {
      margin-top: 8px; font-size: 0.85rem; color: #cbd5e1;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; opacity: 0.8;
    }

    .scroll-btn {
      position: absolute; top: 45%; transform: translateY(-50%); z-index: 30;
      width: 48px; height: 48px; border-radius: 50%;
      background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(4px); color: #fff; font-size: 1.5rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: all 0.2s;
    }
    .scroll-btn:hover { background: rgba(0, 0, 0, 0.9); transform: translateY(-50%) scale(1.1); border-color: var(--accent); }
    .scroll-btn.left { left: 10px; }
    .scroll-btn.right { right: 10px; }
    .row-wrapper:hover .scroll-btn { opacity: 1; }

    /* OVERLAYS & FORMS */
    .overlay-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .overlay-hidden { display: none; }
    .overlay-dialog { background: #18181b; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; max-width: 800px; width: 100%; padding: 24px; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); }
    .overlay-close { position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .overlay-close:hover { background: rgba(255,255,255,0.2); }
    .overlay-layout { display: grid; grid-template-columns: 240px 1fr; gap: 24px; }
    .overlay-poster { border-radius: 8px; overflow: hidden; aspect-ratio: 2/3; }
    .overlay-poster img { width: 100%; height: 100%; object-fit: cover; }
    .overlay-title { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
    .overlay-meta { color: #a1a1aa; margin-bottom: 16px; font-size: 0.9rem; }
    .overlay-desc { line-height: 1.6; color: #d4d4d8; margin-bottom: 24px; }
    .overlay-footer { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-ghost { padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #fff; cursor: pointer; }
    .btn-ghost:hover { border-color: #fff; }
    .btn-primary { padding: 8px 16px; border-radius: 6px; background: var(--accent); color: #fff; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary:hover { filter: brightness(1.1); }
    .form-input { width: 100%; background: #27272a; border: 1px solid #3f3f46; color: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
    .form-label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #a1a1aa; }

    @media (max-width: 768px) {
      header { padding: 0 16px; }
      .search-wrapper { display: none; }
      .hero-content { margin: 0 20px 40px; padding: 20px; }
      .hero-title { font-size: 2rem; }
      .overlay-layout { grid-template-columns: 1fr; }
      .overlay-poster { display: none; }
      .section-header { padding: 0 20px; }
      .movie-row { padding: 10px 20px 30px 20px; gap: 12px; }
      .movie-card { width: 130px; }
      .scroll-btn { width: 36px; height: 36px; font-size: 1.2rem; opacity: 0.7; }
    }
  </style>
</head>
<body>

  <header id="mainHeader">
    <div class="header-left">
      <div class="logo">
        <div class="logo-pill"></div>
        <div>
          <div class="logo-title">NEONSTREAM</div>
          <div class="logo-sub">Streaming Unlimited</div>
        </div>
      </div>
      <button id="addMovieBtn" class="btn-dev-primary hidden">Ajout film</button>
      <button id="addSeriesBtn" class="btn-dev hidden">Ajout s√©rie</button>
      <button id="addCategoryBtn" class="btn-dev hidden">Cat√©gorie</button>
    </div>
    <div class="header-right">
      <div class="search-wrapper">
        <input id="searchInput" class="search-input" type="text" placeholder="Rechercher..." autocomplete="off">
        <span class="search-icon">‚åï</span>
        <div id="searchResults" class="search-dropdown"></div>
      </div>
      <button id="accountBtn" class="btn-dev">Compte</button>
    </div>
  </header>

  <div class="hero-container" id="heroContainer">
    <div class="hero-bg-video">
      <video id="heroTrailer" autoplay muted playsinline></video>
    </div>
    <div class="hero-overlay-gradient"></div>
    <div class="hero-content">
      <div class="hero-chip">En vedette aujourd'hui</div>
      <h1 id="heroTitle" class="hero-title">Chargement...</h1>
      <div id="heroMeta" class="hero-meta"></div>
      <p id="heroDesc" class="hero-desc">Bienvenue sur NeonStream.</p>
      <div class="hero-actions">
        <button id="heroPlayBtn" class="btn-hero-play">‚ñ∂ Lecture</button>
        <button id="heroMoreBtn" class="btn-hero-info">Plus d'infos</button>
        <button id="heroMuteBtn" class="btn-hero-mute">üîá</button>
      </div>
    </div>
  </div>

  <main id="sectionsContainer" class="main-content"></main>

  <div id="overlay" class="overlay-backdrop overlay-hidden">
    <div class="overlay-dialog">
      <button id="overlayClose" class="overlay-close">‚úï</button>
      <div class="overlay-layout">
        <div class="overlay-poster"><img id="overlayPoster" src="" alt="Affiche"></div>
        <div>
          <h2 id="overlayTitle" class="overlay-title">Titre</h2>
          <div id="overlayMeta" class="overlay-meta"></div>
          <div style="margin-bottom:10px; font-size:0.85rem; color:#fff;">Avec : <span id="overlayActors" style="color:#a1a1aa;"></span></div>
          <p id="overlayDesc" class="overlay-desc">Description...</p>
          <div class="overlay-footer">
            <button class="btn-ghost hidden" id="overlayDeleteBtn" style="color:#f87171; border-color:rgba(248,113,113,0.3);">Supprimer</button>
            <button class="btn-ghost" id="overlayWatchTrailerBtn">Voir Trailer</button>
            <button class="btn-primary" id="overlayWatchMovieBtn">Regarder le film</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="accountOverlay" class="overlay-backdrop overlay-hidden">
    <div class="overlay-dialog" style="max-width:400px;">
      <button id="accountClose" class="overlay-close">‚úï</button>
      <h2 class="overlay-title" style="font-size:1.5rem;">Compte</h2>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button id="tabLogin" class="btn-primary" style="flex:1;">Connexion</button>
        <button id="tabRegister" class="btn-ghost" style="flex:1;">Inscription</button>
      </div>
      <form id="loginForm">
        <label class="form-label">Identifiant</label><input id="loginIdentifier" class="form-input" type="text" placeholder="Email ou pseudo">
        <label class="form-label">Mot de passe</label><input id="loginPassword" class="form-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div id="loginError" style="color:#f87171; font-size:0.8rem; margin-top:5px; display:none;">Erreur d'identifiants</div>
        <button type="submit" class="btn-primary" style="width:100%; margin-top:15px;">Se connecter</button>
      </form>
      <form id="registerForm" class="hidden">
        <label class="form-label">Nouvel Identifiant</label><input id="registerIdentifier" class="form-input" type="text">
        <label class="form-label">Mot de passe</label><input id="registerPassword" class="form-input" type="password">
        <label class="form-label">Confirmation</label><input id="registerPassword2" class="form-input" type="password">
        <div id="registerError" style="color:#f87171; font-size:0.8rem; margin-top:5px; display:none;">Erreur</div>
        <button type="submit" class="btn-primary" style="width:100%; margin-top:15px;">Cr√©er compte</button>
      </form>
      <div id="logoutSection" class="hidden" style="text-align:center; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
        <p style="margin-bottom:10px; color:#a1a1aa;">Connect√© en tant que <strong id="currentUserLabel" style="color:#fff;"></strong></p>
        <button id="logoutBtn" class="btn-ghost" style="width:100%;">Se d√©connecter</button>
      </div>
    </div>
  </div>

  <div id="adminOverlay" class="overlay-backdrop overlay-hidden">
    <div class="overlay-dialog" style="max-width:500px; max-height:90vh; overflow-y:auto;">
      <button id="adminClose" class="overlay-close">‚úï</button>
      <h2 id="adminTitle" class="overlay-title" style="font-size:1.5rem;">Ajouter</h2>
      <form id="adminForm" style="display:flex; flex-direction:column; gap:8px;">
        <div><label class="form-label">Titre *</label><input id="fieldName" class="form-input" required></div>
        <div style="display:flex; gap:10px;">
          <div style="flex:1;"><label class="form-label">Ann√©e</label><input id="fieldYear" type="number" class="form-input" value="2024"></div>
          <div style="flex:1;"><label class="form-label">Dur√©e</label><input id="fieldDuration" class="form-input" placeholder="ex: 1h54"></div>
        </div>
        <div><label class="form-label">Genres</label><input id="fieldGenres" class="form-input" placeholder="Action, Drame..."></div>
        <div><label class="form-label">Tags</label><input id="fieldTags" class="form-input" placeholder="new, action..."></div>
        <div><label class="form-label">Acteurs</label><input id="fieldCast" class="form-input"></div>
        <div><label class="form-label">URL Affiche *</label><input id="fieldPoster" class="form-input" required></div>
        <div><label class="form-label">URL Trailer (mp4) *</label><input id="fieldTrailer" class="form-input" required></div>
        <div><label class="form-label">URL Film Complet (mp4) *</label><input id="fieldMovieUrl" class="form-input" required></div>
        <div><label class="form-label">Description</label><textarea id="fieldDescription" class="form-input" style="min-height:80px;"></textarea></div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
          <button type="button" id="adminCancel" class="btn-ghost">Annuler</button>
          <button type="submit" id="adminCreate" class="btn-primary">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <div id="categoryOverlay" class="overlay-backdrop overlay-hidden">
    <div class="overlay-dialog" style="max-width:400px;">
      <button id="categoryClose" class="overlay-close">‚úï</button>
      <h2 class="overlay-title" style="font-size:1.4rem;">G√©rer Cat√©gories</h2>
      <form id="categoryForm" style="margin-bottom:20px;">
        <label class="form-label">Tag (ex: marvel)</label><input id="catKey" class="form-input" required>
        <label class="form-label">Titre affich√©</label><input id="catLabel" class="form-input" required>
        <div id="catError" style="color:#f87171; display:none;">Existe d√©j√†.</div>
        <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">Cr√©er</button>
      </form>
      <div id="categoryList" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAbfM7mh_uGhxXRRMewWNSY3_Fv3mjDJdI",
      authDomain: "neonstream-a1c6e.firebaseapp.com",
      projectId: "neonstream-a1c6e",
      storageBucket: "neonstream-a1c6e.firebasestorage.app",
      messagingSenderId: "799721923216",
      appId: "1:799721923216:web:111dc1985b6dc2acbeee15",
      measurementId: "G-7ZZ06H971F"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const DEV_IDENT = "HerxingDEV01";
    const DEV_PASS = "NEON-DEV-2025";
    const STORAGE_KEY_CURRENT_USER = "neon_current_user";

    const builtInCategories = [
      { key: "new", label: "Nouveaut√©s" },
      { key: "action", label: "Action & Aventure" },
      { key: "sf", label: "Science-Fiction" },
      { key: "thriller", label: "Thrillers" }
    ];

    let movies = [], users = [], customCategories = [], currentUser = null, isDev = false;

    function normalizeText(text) { return (text || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
    function slugify(str) { return normalizeText(str).replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, ""); }
    function shuffle(array) { return [...array].sort(() => Math.random() - 0.5); }
    function movieHasPlayableVideo(m) { return !!(m.trailerUrl || m.videoUrl); }

    async function initApp() {
      await Promise.all([ loadMovies(), loadUsers(), loadCategories() ]);
      loadCurrentUser();
      updateDevStateFromUser();
      initHero();
      renderSections();
      updateAccountUI();
      // On lance le minuteur du header tout de suite
      resetHeaderTimer();
    }

    async function loadMovies() {
      movies = [];
      try {
        const snap = await db.collection("movies").get();
        snap.forEach(doc => {
          const d = doc.data();
          d._searchStr = normalizeText([d.title, (d.genres||[]).join(" "), (d.cast||[]).join(" "), d.year].join(" "));
          movies.push(d);
        });
      } catch(e) { console.error(e); }
    }
    async function saveMovie(m) {
      let toSave = {...m}; delete toSave._searchStr;
      await db.collection("movies").doc(m.id).set(toSave);
    }
    async function deleteMovie(id) { await db.collection("movies").doc(id).delete(); }

    async function loadUsers() {
      users = [];
      const snap = await db.collection("users").get();
      snap.forEach(d => users.push(d.data()));
    }
    async function saveUser(u) { await db.collection("users").doc(u.identifier).set(u); }

    async function loadCategories() {
      customCategories = [];
      const snap = await db.collection("categories").get();
      snap.forEach(d => customCategories.push(d.data()));
    }
    async function saveCategory(c) { await db.collection("categories").doc(c.key).set(c); }
    async function deleteCategory(k) { await db.collection("categories").doc(k).delete(); }

    function getAllCategories() { return [...builtInCategories, ...customCategories]; }

    function loadCurrentUser() { currentUser = localStorage.getItem(STORAGE_KEY_CURRENT_USER); }
    function setCurrentUser(id) {
      currentUser = id;
      if(id) localStorage.setItem(STORAGE_KEY_CURRENT_USER, id);
      else localStorage.removeItem(STORAGE_KEY_CURRENT_USER);
      updateDevStateFromUser();
      updateAccountUI();
    }
    function updateDevStateFromUser() { isDev = (currentUser === DEV_IDENT); }

    const heroVideo = document.getElementById("heroTrailer");
    const heroTitle = document.getElementById("heroTitle");
    const heroMeta = document.getElementById("heroMeta");
    const heroDesc = document.getElementById("heroDesc");
    const heroPlayBtn = document.getElementById("heroPlayBtn");
    const heroMoreBtn = document.getElementById("heroMoreBtn");
    const heroMuteBtn = document.getElementById("heroMuteBtn");
    const heroContainer = document.getElementById("heroContainer");
    
    let trailerPool = [];
    let currentHeroIndex = 0;
    let isMoviePlaying = false; 

    function initHero() {
      trailerPool = shuffle(movies.filter(movieHasPlayableVideo));
      if(!trailerPool.length) {
        heroTitle.textContent = "Bienvenue";
        heroDesc.textContent = "Ajoutez des films...";
        return;
      }
      playHeroMovie(trailerPool[0]);
      
      heroVideo.onended = () => {
        if(isMoviePlaying) {
            // FIN DU FILM : ON RETOURNE AU TRAILER
            exitMovieMode();
        } else {
            // FIN DU TRAILER : ON PASSE AU SUIVANT
            currentHeroIndex = (currentHeroIndex + 1) % trailerPool.length;
            playHeroMovie(trailerPool[currentHeroIndex]);
        }
      };
    }

    // FONCTION POUR LANCER UN FILM (Mode Cin√©ma)
    function enterMovieMode(url) {
        isMoviePlaying = true;
        
        // Cache l'interface
        heroContainer.classList.add('playing-mode');
        document.body.classList.add('cinema-mode'); 
        
        // On force le header √† remonter tout de suite
        hideHeader();

        // Setup Vid√©o
        heroVideo.src = url;
        heroVideo.currentTime = 0;
        heroVideo.muted = false;
        heroVideo.controls = true;
        heroVideo.style.objectFit = 'contain';
        
        heroVideo.play();
        window.scrollTo({top:0, behavior:'smooth'});
        
        // Fullscreen auto
        if(heroVideo.requestFullscreen) heroVideo.requestFullscreen();
        else if(heroVideo.webkitRequestFullscreen) heroVideo.webkitRequestFullscreen();
    }

    // FONCTION POUR SORTIR DU MODE FILM
    function exitMovieMode() {
        isMoviePlaying = false;
        
        // Quitte le fullscreen si actif
        if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});
        
        // R√©affiche l'interface
        heroContainer.classList.remove('playing-mode');
        document.body.classList.remove('cinema-mode');
        
        // Reset Vid√©o en mode Trailer
        heroVideo.controls = false;
        heroVideo.style.objectFit = 'cover';
        heroVideo.muted = true;
        
        // Reprend la boucle des trailers
        playHeroMovie(trailerPool[currentHeroIndex]);
        
        // R√©affiche le header
        showHeader();
    }

    function playHeroMovie(movie) {
      if(isMoviePlaying) return; 

      heroVideo.src = movie.trailerUrl || movie.videoUrl;
      heroVideo.muted = true;
      heroVideo.play().catch(()=>{});
      updateMuteIcon();

      heroTitle.textContent = movie.title;
      heroDesc.textContent = movie.description;
      heroMeta.innerHTML = `<span class="badge">${movie.year}</span><span class="badge">${movie.duration}</span><span class="badge">${(movie.genres||[]).slice(0,3).join(" ‚Ä¢ ")}</span>`;
      
      // BOUTON LECTURE -> LANCE LE FILM COMPLET
      heroPlayBtn.onclick = () => {
         const movieUrl = movie.videoUrl || movie.trailerUrl;
         enterMovieMode(movieUrl);
      };
      
      heroMoreBtn.onclick = () => openOverlay(movie);
    }
    
    heroMuteBtn.onclick = () => {
      heroVideo.muted = !heroVideo.muted;
      updateMuteIcon();
    };

    function updateMuteIcon() {
      heroMuteBtn.textContent = heroVideo.muted ? "üîá" : "üîä";
    }

    // --- LOGIQUE HEADER AUTO-HIDE ---
    let headerTimeout;
    const header = document.getElementById('mainHeader');
    const searchInputEl = document.getElementById('searchInput');

    function showHeader() {
        header.classList.remove('header-auto-hide');
    }

    function hideHeader() {
        // Ne pas cacher si on est focus sur la recherche ou si la souris est sur le header
        if (document.activeElement === searchInputEl || header.matches(':hover')) return;
        header.classList.add('header-auto-hide');
    }

    function resetHeaderTimer() {
        showHeader();
        clearTimeout(headerTimeout);
        headerTimeout = setTimeout(hideHeader, 6000); // 6 secondes
    }

    // D√©tection globale du mouvement de souris
    document.addEventListener('mousemove', () => {
        // Fonctionne tout le temps, m√™me pendant le film
        resetHeaderTimer();
    });

    // Gestion du scroll pour le fond sombre
    window.addEventListener("scroll", () => {
      if(window.scrollY > 50) header.classList.add("scrolled");
      else header.classList.remove("scrolled");
    });

    // Exceptions pour le header
    header.addEventListener('mouseenter', () => clearTimeout(headerTimeout));
    header.addEventListener('mouseleave', resetHeaderTimer);
    searchInputEl.addEventListener('focus', () => clearTimeout(headerTimeout));
    searchInputEl.addEventListener('blur', resetHeaderTimer);


    const sectionsContainer = document.getElementById("sectionsContainer");
    function renderSections() {
      sectionsContainer.innerHTML = "";
      getAllCategories().forEach(cat => {
        const catMovies = movies.filter(m => (m.tags||[]).includes(cat.key));
        if(!catMovies.length) return;
        const sec = document.createElement("section");
        sec.innerHTML = `
          <div class="section-header"><h3 class="section-title">${cat.label}</h3></div>
          <div class="row-wrapper">
            <button class="scroll-btn left" onclick="scrollRow(this, -300)">‚Äπ</button>
            <div class="movie-row">
              ${catMovies.map(m => `
                <div class="movie-card" data-id="${m.id}">
                  <div class="poster-wrapper"><img src="${m.poster}" loading="lazy" alt="${m.title}"></div>
                  <div class="movie-title-mini">${m.title}</div>
                </div>
              `).join("")}
            </div>
            <button class="scroll-btn right" onclick="scrollRow(this, 300)">‚Ä∫</button>
          </div>
        `;
        sectionsContainer.appendChild(sec);
      });
      document.querySelectorAll(".movie-card").forEach(card => {
        card.addEventListener("click", () => {
          const m = movies.find(x => x.id === card.dataset.id);
          if(m) openOverlay(m);
        });
      });
    }

    window.scrollRow = (btn, amount) => {
      const wrapper = btn.closest('.row-wrapper');
      const row = wrapper.querySelector('.movie-row');
      row.scrollBy({ left: amount, behavior: 'smooth' });
    };

    const searchResults = document.getElementById("searchResults");
    searchInputEl.addEventListener("input", (e) => {
      const q = normalizeText(e.target.value);
      const cards = document.querySelectorAll(".movie-card");
      if(!q) {
        cards.forEach(c => c.classList.remove("dimmed"));
        searchResults.classList.remove("active");
        return;
      }
      const matches = movies.filter(m => m._searchStr && m._searchStr.includes(q));
      const matchIds = new Set(matches.map(m => m.id));
      cards.forEach(c => {
        if(matchIds.has(c.dataset.id)) c.classList.remove("dimmed");
        else c.classList.add("dimmed");
      });
      renderDropdown(matches);
    });

    function renderDropdown(list) {
      searchResults.innerHTML = "";
      if(!list.length) {
        searchResults.innerHTML = `<div class="search-no-result">Aucun r√©sultat</div>`;
      } else {
        list.forEach(m => {
          const div = document.createElement("div");
          div.className = "search-result-item";
          div.innerHTML = `
            <img class="search-result-thumb" src="${m.poster}">
            <div class="search-result-info">
              <div class="search-result-title">${m.title}</div>
              <div class="search-result-meta">${m.year}</div>
            </div>
          `;
          div.onclick = () => { openOverlay(m); searchResults.classList.remove("active"); };
          searchResults.appendChild(div);
        });
      }
      searchResults.classList.add("active");
    }
    document.addEventListener("click", (e) => {
      if(!searchInputEl.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.remove("active");
      }
    });

    const overlay = document.getElementById("overlay");
    function openOverlay(m) {
      document.getElementById("overlayPoster").src = m.poster;
      document.getElementById("overlayTitle").textContent = m.title;
      document.getElementById("overlayDesc").textContent = m.description;
      document.getElementById("overlayActors").textContent = (m.cast||[]).join(", ");
      document.getElementById("overlayMeta").textContent = `${m.year} ‚Ä¢ ${m.duration} ‚Ä¢ ${(m.genres||[]).join(", ")}`;
      
      document.getElementById("overlayWatchMovieBtn").onclick = () => {
         const movieUrl = m.videoUrl || m.trailerUrl;
         closeAllOverlays();
         enterMovieMode(movieUrl);
      };
      
      document.getElementById("overlayWatchTrailerBtn").onclick = () => {
         const movieUrl = m.trailerUrl || m.videoUrl;
         closeAllOverlays();
         // Pour le trailer, on lance aussi en mode cin√©ma pour bien voir
         enterMovieMode(movieUrl);
      };
      const btnDel = document.getElementById("overlayDeleteBtn");
      if(isDev) {
        btnDel.classList.remove("hidden");
        btnDel.onclick = async () => {
          if(!confirm("Supprimer ?")) return;
          await deleteMovie(m.id); location.reload();
        }
      } else { btnDel.classList.add("hidden"); }
      overlay.classList.remove("overlay-hidden");
    }

    function closeAllOverlays() { document.querySelectorAll(".overlay-backdrop").forEach(el => el.classList.add("overlay-hidden")); }
    document.querySelectorAll(".overlay-close").forEach(btn => btn.onclick = closeAllOverlays);

    const adminOverlay = document.getElementById("adminOverlay");
    const catOverlay = document.getElementById("categoryOverlay");
    const accountOverlay = document.getElementById("accountOverlay");
    
    document.getElementById("addMovieBtn").onclick = () => { openAdmin("film"); document.getElementById("adminForm").reset(); };
    document.getElementById("addSeriesBtn").onclick = () => { openAdmin("serie"); document.getElementById("adminForm").reset(); };
    document.getElementById("addCategoryBtn").onclick = () => { catOverlay.classList.remove("overlay-hidden"); renderCatList(); };
    document.getElementById("accountBtn").onclick = () => accountOverlay.classList.remove("overlay-hidden");

    let currentAdminType = "film";
    function openAdmin(type) {
      currentAdminType = type;
      document.getElementById("adminTitle").textContent = type === 'film' ? "Ajouter Film" : "Ajouter S√©rie";
      adminOverlay.classList.remove("overlay-hidden");
    }
    document.getElementById("adminForm").onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById("fieldName").value;
      if(movies.some(m => normalizeText(m.title) === normalizeText(title))) { alert("Ce film existe d√©j√† !"); return; }
      const newMovie = {
        id: slugify(title) + "-" + Date.now(), type: currentAdminType, title: title,
        year: document.getElementById("fieldYear").value, duration: document.getElementById("fieldDuration").value,
        genres: document.getElementById("fieldGenres").value.split(",").map(s=>s.trim()).filter(Boolean),
        tags: document.getElementById("fieldTags").value.split(",").map(s=>s.trim().toLowerCase()).filter(Boolean),
        cast: document.getElementById("fieldCast").value.split(",").map(s=>s.trim()).filter(Boolean),
        poster: document.getElementById("fieldPoster").value, trailerUrl: document.getElementById("fieldTrailer").value,
        videoUrl: document.getElementById("fieldMovieUrl").value, description: document.getElementById("fieldDescription").value
      };
      newMovie._searchStr = normalizeText([newMovie.title, ...newMovie.genres, ...newMovie.cast, newMovie.year].join(" "));
      movies.push(newMovie); await saveMovie(newMovie);
      closeAllOverlays(); renderSections(); alert("Ajout√© avec succ√®s !");
    };
    document.getElementById("adminCancel").onclick = closeAllOverlays;

    document.getElementById("categoryForm").onsubmit = async (e) => {
      e.preventDefault();
      const k = document.getElementById("catKey").value.toLowerCase().trim();
      const l = document.getElementById("catLabel").value.trim();
      const newC = { key: k, label: l };
      customCategories.push(newC); await saveCategory(newC);
      renderCatList(); renderSections(); document.getElementById("categoryForm").reset();
    };
    function renderCatList() {
      document.getElementById("categoryList").innerHTML = customCategories.map(c => `
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.8rem;">
           <span>${c.label} (${c.key})</span><span style="color:red; cursor:pointer;" onclick="removeCat('${c.key}')">Suppr.</span>
        </div>`).join("");
    }
    window.removeCat = async (k) => {
      if(!confirm("Supprimer ?")) return;
      customCategories = customCategories.filter(c => c.key !== k);
      await deleteCategory(k); renderCatList(); renderSections();
    };

    const tabLogin = document.getElementById("tabLogin"), tabRegister = document.getElementById("tabRegister");
    const formLogin = document.getElementById("loginForm"), formRegister = document.getElementById("registerForm");
    tabLogin.onclick = () => { tabLogin.classList.replace("btn-ghost", "btn-primary"); tabRegister.classList.replace("btn-primary", "btn-ghost"); formLogin.classList.remove("hidden"); formRegister.classList.add("hidden"); };
    tabRegister.onclick = () => { tabRegister.classList.replace("btn-ghost", "btn-primary"); tabLogin.classList.replace("btn-primary", "btn-ghost"); formRegister.classList.remove("hidden"); formLogin.classList.add("hidden"); };
    
    formLogin.onsubmit = (e) => {
      e.preventDefault();
      const id = document.getElementById("loginIdentifier").value.trim(), pass = document.getElementById("loginPassword").value;
      if(id === DEV_IDENT && pass === DEV_PASS) { setCurrentUser(id); closeAllOverlays(); return; }
      const u = users.find(x => x.identifier === id && x.password === pass);
      if(u) { setCurrentUser(u.identifier); closeAllOverlays(); } else { document.getElementById("loginError").style.display = "block"; }
    };
    formRegister.onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById("registerIdentifier").value.trim(), pass = document.getElementById("registerPassword").value, pass2 = document.getElementById("registerPassword2").value;
      if(pass !== pass2) { alert("Mots de passe diff√©rents"); return; }
      if(users.some(u => u.identifier === id)) { alert("Existe d√©j√†"); return; }
      const newU = { identifier: id, password: pass };
      users.push(newU); await saveUser(newU); setCurrentUser(id); closeAllOverlays();
    };
    document.getElementById("logoutBtn").onclick = () => { setCurrentUser(null); closeAllOverlays(); };
    function updateAccountUI() {
      const btn = document.getElementById("accountBtn"), logoutSec = document.getElementById("logoutSection");
      if(currentUser) { btn.textContent = currentUser; document.getElementById("currentUserLabel").textContent = currentUser; logoutSec.classList.remove("hidden"); }
      else { btn.textContent = "Compte"; logoutSec.classList.add("hidden"); }
      const devs = [document.getElementById("addMovieBtn"), document.getElementById("addSeriesBtn"), document.getElementById("addCategoryBtn")];
      if(isDev) devs.forEach(b => b.classList.remove("hidden")); else devs.forEach(b => b.classList.add("hidden"));
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>